(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))f(i);new MutationObserver(i=>{for(const e of i)if(e.type==="childList")for(const t of e.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&f(t)}).observe(document,{childList:!0,subtree:!0});function l(i){const e={};return i.integrity&&(e.integrity=i.integrity),i.referrerPolicy&&(e.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?e.credentials="include":i.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function f(i){if(i.ep)return;i.ep=!0;const e=l(i);fetch(i.href,e)}})();function ot(n){if(Object.prototype.hasOwnProperty.call(n,"__esModule"))return n;var c=n.default;if(typeof c=="function"){var l=function f(){return this instanceof f?Reflect.construct(c,arguments,this.constructor):c.apply(this,arguments)};l.prototype=c.prototype}else l={};return Object.defineProperty(l,"__esModule",{value:!0}),Object.keys(n).forEach(function(f){var i=Object.getOwnPropertyDescriptor(n,f);Object.defineProperty(l,f,i.get?i:{enumerable:!0,get:function(){return n[f]}})}),l}var V={},ce={},me,ke;function st(){if(ke)return me;ke=1;function n(i){var e=new f(i),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var u=c(t.data),o=[],a=0;!e.eof()&&a<u.numTracks;a++){var r=e.readChunk();if(r.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+r.id+"'";var s=l(r.data);o.push(s)}return{header:u,tracks:o}}function c(i){var e=new f(i),t=e.readUInt16(),u=e.readUInt16(),o={format:t,numTracks:u},a=e.readUInt16();return a&32768?(o.framesPerSecond=256-(a>>8),o.ticksPerFrame=a&255):o.ticksPerBeat=a,o}function l(i){for(var e=new f(i),t=[];!e.eof();){var u=a();t.push(u)}return t;var o;function a(){var r={};r.deltaTime=e.readVarInt();var s=e.readUInt8();if((s&240)===240)if(s===255){r.meta=!0;var m=e.readUInt8(),d=e.readVarInt();switch(m){case 0:if(r.type="sequenceNumber",d!==2)throw"Expected length for sequenceNumber event is 2, got "+d;return r.number=e.readUInt16(),r;case 1:return r.type="text",r.text=e.readString(d),r;case 2:return r.type="copyrightNotice",r.text=e.readString(d),r;case 3:return r.type="trackName",r.text=e.readString(d),r;case 4:return r.type="instrumentName",r.text=e.readString(d),r;case 5:return r.type="lyrics",r.text=e.readString(d),r;case 6:return r.type="marker",r.text=e.readString(d),r;case 7:return r.type="cuePoint",r.text=e.readString(d),r;case 32:if(r.type="channelPrefix",d!=1)throw"Expected length for channelPrefix event is 1, got "+d;return r.channel=e.readUInt8(),r;case 33:if(r.type="portPrefix",d!=1)throw"Expected length for portPrefix event is 1, got "+d;return r.port=e.readUInt8(),r;case 47:if(r.type="endOfTrack",d!=0)throw"Expected length for endOfTrack event is 0, got "+d;return r;case 81:if(r.type="setTempo",d!=3)throw"Expected length for setTempo event is 3, got "+d;return r.microsecondsPerBeat=e.readUInt24(),r;case 84:if(r.type="smpteOffset",d!=5)throw"Expected length for smpteOffset event is 5, got "+d;var I=e.readUInt8(),k={0:24,32:25,64:29,96:30};return r.frameRate=k[I&96],r.hour=I&31,r.min=e.readUInt8(),r.sec=e.readUInt8(),r.frame=e.readUInt8(),r.subFrame=e.readUInt8(),r;case 88:if(r.type="timeSignature",d!=2&&d!=4)throw"Expected length for timeSignature event is 4 or 2, got "+d;return r.numerator=e.readUInt8(),r.denominator=1<<e.readUInt8(),d===4?(r.metronome=e.readUInt8(),r.thirtyseconds=e.readUInt8()):(r.metronome=36,r.thirtyseconds=8),r;case 89:if(r.type="keySignature",d!=2)throw"Expected length for keySignature event is 2, got "+d;return r.key=e.readInt8(),r.scale=e.readUInt8(),r;case 127:return r.type="sequencerSpecific",r.data=e.readBytes(d),r;default:return r.type="unknownMeta",r.data=e.readBytes(d),r.metatypeByte=m,r}}else if(s==240){r.type="sysEx";var d=e.readVarInt();return r.data=e.readBytes(d),r}else if(s==247){r.type="endSysEx";var d=e.readVarInt();return r.data=e.readBytes(d),r}else throw"Unrecognised MIDI event type byte: "+s;else{var g;if((s&128)===0){if(o===null)throw"Running status byte encountered before status byte";g=s,s=o,r.running=!0}else g=e.readUInt8(),o=s;var p=s>>4;switch(r.channel=s&15,p){case 8:return r.type="noteOff",r.noteNumber=g,r.velocity=e.readUInt8(),r;case 9:var y=e.readUInt8();return r.type=y===0?"noteOff":"noteOn",r.noteNumber=g,r.velocity=y,y===0&&(r.byte9=!0),r;case 10:return r.type="noteAftertouch",r.noteNumber=g,r.amount=e.readUInt8(),r;case 11:return r.type="controller",r.controllerType=g,r.value=e.readUInt8(),r;case 12:return r.type="programChange",r.programNumber=g,r;case 13:return r.type="channelAftertouch",r.amount=g,r;case 14:return r.type="pitchBend",r.value=g+(e.readUInt8()<<7)-8192,r;default:throw"Unrecognised MIDI event type: "+p}}}}function f(i){this.buffer=i,this.bufferLen=this.buffer.length,this.pos=0}return f.prototype.eof=function(){return this.pos>=this.bufferLen},f.prototype.readUInt8=function(){var i=this.buffer[this.pos];return this.pos+=1,i},f.prototype.readInt8=function(){var i=this.readUInt8();return i&128?i-256:i},f.prototype.readUInt16=function(){var i=this.readUInt8(),e=this.readUInt8();return(i<<8)+e},f.prototype.readInt16=function(){var i=this.readUInt16();return i&32768?i-65536:i},f.prototype.readUInt24=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(i<<16)+(e<<8)+t},f.prototype.readInt24=function(){var i=this.readUInt24();return i&8388608?i-16777216:i},f.prototype.readUInt32=function(){var i=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),u=this.readUInt8();return(i<<24)+(e<<16)+(t<<8)+u},f.prototype.readBytes=function(i){var e=this.buffer.slice(this.pos,this.pos+i);return this.pos+=i,e},f.prototype.readString=function(i){var e=this.readBytes(i);return String.fromCharCode.apply(null,e)},f.prototype.readVarInt=function(){for(var i=0;!this.eof();){var e=this.readUInt8();if(e&128)i+=e&127,i<<=7;else return i+e}return i},f.prototype.readChunk=function(){var i=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:i,length:e,data:t}},me=n,me}var pe,xe;function ct(){if(xe)return pe;xe=1;function n(e,t){if(typeof e!="object")throw"Invalid MIDI data";t=t||{};var u=e.header||{},o=e.tracks||[],a,r=o.length,s=new i;for(c(s,u,r),a=0;a<r;a++)l(s,o[a],t);return s.buffer}function c(e,t,u){var o=t.format==null?1:t.format,a=128;t.timeDivision?a=t.timeDivision:t.ticksPerFrame&&t.framesPerSecond?a=-(t.framesPerSecond&255)<<8|t.ticksPerFrame&255:t.ticksPerBeat&&(a=t.ticksPerBeat&32767);var r=new i;r.writeUInt16(o),r.writeUInt16(u),r.writeUInt16(a),e.writeChunk("MThd",r.buffer)}function l(e,t,u){var o=new i,a,r=t.length,s=null;for(a=0;a<r;a++)(u.running===!1||!u.running&&!t[a].running)&&(s=null),s=f(o,t[a],s,u.useByte9ForNoteOff);e.writeChunk("MTrk",o.buffer)}function f(e,t,u,o){var a=t.type,r=t.deltaTime,s=t.text||"",m=t.data||[],d=null;switch(e.writeVarInt(r),a){case"sequenceNumber":e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(t.number);break;case"text":e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(s.length),e.writeString(s);break;case"copyrightNotice":e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(s.length),e.writeString(s);break;case"trackName":e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(s.length),e.writeString(s);break;case"instrumentName":e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(s.length),e.writeString(s);break;case"lyrics":e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(s.length),e.writeString(s);break;case"marker":e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(s.length),e.writeString(s);break;case"cuePoint":e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(s.length),e.writeString(s);break;case"channelPrefix":e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(t.channel);break;case"portPrefix":e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(t.port);break;case"endOfTrack":e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case"setTempo":e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(t.microsecondsPerBeat);break;case"smpteOffset":e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5);var I={24:0,25:32,29:64,30:96},k=t.hour&31|I[t.frameRate];e.writeUInt8(k),e.writeUInt8(t.min),e.writeUInt8(t.sec),e.writeUInt8(t.frame),e.writeUInt8(t.subFrame);break;case"timeSignature":e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(t.numerator);var g=Math.floor(Math.log(t.denominator)/Math.LN2)&255;e.writeUInt8(g),e.writeUInt8(t.metronome),e.writeUInt8(t.thirtyseconds||8);break;case"keySignature":e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(t.key),e.writeUInt8(t.scale);break;case"sequencerSpecific":e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(m.length),e.writeBytes(m);break;case"unknownMeta":t.metatypeByte!=null&&(e.writeUInt8(255),e.writeUInt8(t.metatypeByte),e.writeVarInt(m.length),e.writeBytes(m));break;case"sysEx":e.writeUInt8(240),e.writeVarInt(m.length),e.writeBytes(m);break;case"endSysEx":e.writeUInt8(247),e.writeVarInt(m.length),e.writeBytes(m);break;case"noteOff":var p=o!==!1&&t.byte9||o&&t.velocity==0?144:128;d=p|t.channel,d!==u&&e.writeUInt8(d),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteOn":d=144|t.channel,d!==u&&e.writeUInt8(d),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteAftertouch":d=160|t.channel,d!==u&&e.writeUInt8(d),e.writeUInt8(t.noteNumber),e.writeUInt8(t.amount);break;case"controller":d=176|t.channel,d!==u&&e.writeUInt8(d),e.writeUInt8(t.controllerType),e.writeUInt8(t.value);break;case"programChange":d=192|t.channel,d!==u&&e.writeUInt8(d),e.writeUInt8(t.programNumber);break;case"channelAftertouch":d=208|t.channel,d!==u&&e.writeUInt8(d),e.writeUInt8(t.amount);break;case"pitchBend":d=224|t.channel,d!==u&&e.writeUInt8(d);var y=8192+t.value,b=y&127,h=y>>7&127;e.writeUInt8(b),e.writeUInt8(h);break;default:throw"Unrecognized event type: "+a}return d}function i(){this.buffer=[]}return i.prototype.writeUInt8=function(e){this.buffer.push(e&255)},i.prototype.writeInt8=i.prototype.writeUInt8,i.prototype.writeUInt16=function(e){var t=e>>8&255,u=e&255;this.writeUInt8(t),this.writeUInt8(u)},i.prototype.writeInt16=i.prototype.writeUInt16,i.prototype.writeUInt24=function(e){var t=e>>16&255,u=e>>8&255,o=e&255;this.writeUInt8(t),this.writeUInt8(u),this.writeUInt8(o)},i.prototype.writeInt24=i.prototype.writeUInt24,i.prototype.writeUInt32=function(e){var t=e>>24&255,u=e>>16&255,o=e>>8&255,a=e&255;this.writeUInt8(t),this.writeUInt8(u),this.writeUInt8(o),this.writeUInt8(a)},i.prototype.writeInt32=i.prototype.writeUInt32,i.prototype.writeBytes=function(e){this.buffer=this.buffer.concat(Array.prototype.slice.call(e,0))},i.prototype.writeString=function(e){var t,u=e.length,o=[];for(t=0;t<u;t++)o.push(e.codePointAt(t));this.writeBytes(o)},i.prototype.writeVarInt=function(e){if(e<0)throw"Cannot write negative variable-length integer";if(e<=127)this.writeUInt8(e);else{var t=e,u=[];for(u.push(t&127),t>>=7;t;){var o=t&127|128;u.push(o),t>>=7}this.writeBytes(u.reverse())}},i.prototype.writeChunk=function(e,t){this.writeString(e),this.writeUInt32(t.length),this.writeBytes(t)},pe=n,pe}var Te;function $e(){return Te||(Te=1,ce.parseMidi=st(),ce.writeMidi=ct()),ce}var ge={},H={},we;function je(){if(we)return H;we=1,Object.defineProperty(H,"__esModule",{value:!0}),H.insert=H.search=void 0;function n(l,f,i){i===void 0&&(i="ticks");var e=0,t=l.length,u=t;if(t>0&&l[t-1][i]<=f)return t-1;for(;e<u;){var o=Math.floor(e+(u-e)/2),a=l[o],r=l[o+1];if(a[i]===f){for(var s=o;s<l.length;s++){var m=l[s];m[i]===f&&(o=s)}return o}else{if(a[i]<f&&r[i]>f)return o;a[i]>f?u=o:a[i]<f&&(e=o+1)}}return-1}H.search=n;function c(l,f,i){if(i===void 0&&(i="ticks"),l.length){var e=n(l,f[i],i);l.splice(e+1,0,f)}else l.push(f)}return H.insert=c,H}var Ue;function ve(){return Ue||(Ue=1,(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.Header=n.keySignatureKeys=void 0;var c=je(),l=new WeakMap;n.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var f=(function(){function i(e){var t=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",l.set(this,480),e){l.set(this,e.header.ticksPerBeat),e.tracks.forEach(function(o){o.forEach(function(a){a.meta&&(a.type==="timeSignature"?t.timeSignatures.push({ticks:a.absoluteTime,timeSignature:[a.numerator,a.denominator]}):a.type==="setTempo"?t.tempos.push({bpm:6e7/a.microsecondsPerBeat,ticks:a.absoluteTime}):a.type==="keySignature"&&t.keySignatures.push({key:n.keySignatureKeys[a.key+7],scale:a.scale===0?"major":"minor",ticks:a.absoluteTime}))})});var u=0;e.tracks[0].forEach(function(o){u+=o.deltaTime,o.meta&&(o.type==="trackName"?t.name=o.text:(o.type==="text"||o.type==="cuePoint"||o.type==="marker"||o.type==="lyrics")&&t.meta.push({text:o.text,ticks:u,type:o.type}))}),this.update()}}return i.prototype.update=function(){var e=this,t=0,u=0;this.tempos.sort(function(o,a){return o.ticks-a.ticks}),this.tempos.forEach(function(o,a){var r=a>0?e.tempos[a-1].bpm:e.tempos[0].bpm,s=o.ticks/e.ppq-u,m=60/r*s;o.time=m+t,t=o.time,u+=s}),this.timeSignatures.sort(function(o,a){return o.ticks-a.ticks}),this.timeSignatures.forEach(function(o,a){var r=a>0?e.timeSignatures[a-1]:e.timeSignatures[0],s=(o.ticks-r.ticks)/e.ppq,m=s/r.timeSignature[0]/(r.timeSignature[1]/4);r.measures=r.measures||0,o.measures=m+r.measures})},i.prototype.ticksToSeconds=function(e){var t=(0,c.search)(this.tempos,e);if(t!==-1){var u=this.tempos[t],o=u.time,a=(e-u.ticks)/this.ppq;return o+60/u.bpm*a}else{var r=e/this.ppq;return 60/120*r}},i.prototype.ticksToMeasures=function(e){var t=(0,c.search)(this.timeSignatures,e);if(t!==-1){var u=this.timeSignatures[t],o=(e-u.ticks)/this.ppq;return u.measures+o/(u.timeSignature[0]/u.timeSignature[1])/4}else return e/this.ppq/4},Object.defineProperty(i.prototype,"ppq",{get:function(){return l.get(this)},enumerable:!1,configurable:!0}),i.prototype.secondsToTicks=function(e){var t=(0,c.search)(this.tempos,e,"time");if(t!==-1){var u=this.tempos[t],o=u.time,a=e-o,r=a/(60/u.bpm);return Math.round(u.ticks+r*this.ppq)}else{var s=e/.5;return Math.round(s*this.ppq)}},i.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(e){return{bpm:e.bpm,ticks:e.ticks}}),timeSignatures:this.timeSignatures}},i.prototype.fromJSON=function(e){this.name=e.name,this.tempos=e.tempos.map(function(t){return Object.assign({},t)}),this.timeSignatures=e.timeSignatures.map(function(t){return Object.assign({},t)}),this.keySignatures=e.keySignatures.map(function(t){return Object.assign({},t)}),this.meta=e.meta.map(function(t){return Object.assign({},t)}),l.set(this,e.ppq),this.update()},i.prototype.setTempo=function(e){this.tempos=[{bpm:e,ticks:0}],this.update()},i})();n.Header=f})(ge)),ge}var ee={},ye={},Se;function Ae(){return Se||(Se=1,(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.ControlChange=n.controlChangeIds=n.controlChangeNames=void 0,n.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},n.controlChangeIds=Object.keys(n.controlChangeNames).reduce(function(i,e){return i[n.controlChangeNames[e]]=e,i},{});var c=new WeakMap,l=new WeakMap,f=(function(){function i(e,t){c.set(this,t),l.set(this,e.controllerType),this.ticks=e.absoluteTime,this.value=e.value}return Object.defineProperty(i.prototype,"number",{get:function(){return l.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return n.controlChangeNames[this.number]?n.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"time",{get:function(){var e=c.get(this);return e.ticksToSeconds(this.ticks)},set:function(e){var t=c.get(this);this.ticks=t.secondsToTicks(e)},enumerable:!1,configurable:!0}),i.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},i})();n.ControlChange=f})(ye)),ye}var te={},Ce;function ut(){if(Ce)return te;Ce=1,Object.defineProperty(te,"__esModule",{value:!0}),te.createControlChanges=void 0;var n=Ae();function c(){return new Proxy({},{get:function(l,f){if(l[f])return l[f];if(n.controlChangeIds.hasOwnProperty(f))return l[n.controlChangeIds[f]]},set:function(l,f,i){return n.controlChangeIds.hasOwnProperty(f)?l[n.controlChangeIds[f]]=i:l[f]=i,!0}})}return te.createControlChanges=c,te}var re={},Me;function lt(){if(Me)return re;Me=1,Object.defineProperty(re,"__esModule",{value:!0}),re.PitchBend=void 0;var n=new WeakMap,c=(function(){function l(f,i){n.set(this,i),this.ticks=f.absoluteTime,this.value=f.value}return Object.defineProperty(l.prototype,"time",{get:function(){var f=n.get(this);return f.ticksToSeconds(this.ticks)},set:function(f){var i=n.get(this);this.ticks=i.secondsToTicks(f)},enumerable:!1,configurable:!0}),l.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},l})();return re.PitchBend=c,re}var ne={},L={},Oe;function dt(){return Oe||(Oe=1,Object.defineProperty(L,"__esModule",{value:!0}),L.DrumKitByPatchID=L.InstrumentFamilyByID=L.instrumentByPatchID=void 0,L.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],L.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],L.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"}),L}var Be;function ft(){if(Be)return ne;Be=1,Object.defineProperty(ne,"__esModule",{value:!0}),ne.Instrument=void 0;var n=dt(),c=new WeakMap,l=(function(){function f(i,e){if(this.number=0,c.set(this,e),this.number=0,i){var t=i.find(function(u){return u.type==="programChange"});t&&(this.number=t.programNumber)}}return Object.defineProperty(f.prototype,"name",{get:function(){return this.percussion?n.DrumKitByPatchID[this.number]:n.instrumentByPatchID[this.number]},set:function(i){var e=n.instrumentByPatchID.indexOf(i);e!==-1&&(this.number=e)},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"family",{get:function(){return this.percussion?"drums":n.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"percussion",{get:function(){var i=c.get(this);return i.channel===9},enumerable:!1,configurable:!0}),f.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},f.prototype.fromJSON=function(i){this.number=i.number},f})();return ne.Instrument=l,ne}var ie={},Ee;function ht(){if(Ee)return ie;Ee=1,Object.defineProperty(ie,"__esModule",{value:!0}),ie.Note=void 0;function n(t){var u=Math.floor(t/12)-1;return c(t)+u.toString()}function c(t){var u=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],o=t%12;return u[o]}function l(t){var u=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return u.indexOf(t)}var f=(function(){var t=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,u={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(o){var a=t.exec(o),r=a[1],s=a[2],m=u[r.toLowerCase()];return m+(parseInt(s,10)+1)*12}})(),i=new WeakMap,e=(function(){function t(u,o,a){i.set(this,a),this.midi=u.midi,this.velocity=u.velocity,this.noteOffVelocity=o.velocity,this.ticks=u.ticks,this.durationTicks=o.ticks-u.ticks}return Object.defineProperty(t.prototype,"name",{get:function(){return n(this.midi)},set:function(u){this.midi=f(u)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(u){var o=u-this.octave;this.midi+=o*12},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pitch",{get:function(){return c(this.midi)},set:function(u){this.midi=12*(this.octave+1)+l(u)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"duration",{get:function(){var u=i.get(this);return u.ticksToSeconds(this.ticks+this.durationTicks)-u.ticksToSeconds(this.ticks)},set:function(u){var o=i.get(this),a=o.secondsToTicks(this.time+u);this.durationTicks=a-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"time",{get:function(){var u=i.get(this);return u.ticksToSeconds(this.ticks)},set:function(u){var o=i.get(this);this.ticks=o.secondsToTicks(u)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bars",{get:function(){var u=i.get(this);return u.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),t.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},t})();return ie.Note=e,ie}var Ne;function Pe(){if(Ne)return ee;Ne=1,Object.defineProperty(ee,"__esModule",{value:!0}),ee.Track=void 0;var n=je(),c=Ae(),l=ut(),f=lt(),i=ft(),e=ht(),t=new WeakMap,u=(function(){function o(a,r){var s=this;if(this.name="",this.notes=[],this.controlChanges=(0,l.createControlChanges)(),this.pitchBends=[],t.set(this,r),a){var m=a.find(function(h){return h.type==="trackName"});this.name=m?m.text:""}if(this.instrument=new i.Instrument(a,this),this.channel=0,a){for(var d=a.filter(function(h){return h.type==="noteOn"}),I=a.filter(function(h){return h.type==="noteOff"}),k=function(){var h=d.shift();g.channel=h.channel;var x=I.findIndex(function(K){return K.noteNumber===h.noteNumber&&K.absoluteTime>=h.absoluteTime});if(x!==-1){var S=I.splice(x,1)[0];g.addNote({durationTicks:S.absoluteTime-h.absoluteTime,midi:h.noteNumber,noteOffVelocity:S.velocity/127,ticks:h.absoluteTime,velocity:h.velocity/127})}},g=this;d.length;)k();var p=a.filter(function(h){return h.type==="controller"});p.forEach(function(h){s.addCC({number:h.controllerType,ticks:h.absoluteTime,value:h.value/127})});var y=a.filter(function(h){return h.type==="pitchBend"});y.forEach(function(h){s.addPitchBend({ticks:h.absoluteTime,value:h.value/Math.pow(2,13)})});var b=a.find(function(h){return h.type==="endOfTrack"});this.endOfTrackTicks=b!==void 0?b.absoluteTime:void 0}}return o.prototype.addNote=function(a){var r=t.get(this),s=new e.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},r);return Object.assign(s,a),(0,n.insert)(this.notes,s,"ticks"),this},o.prototype.addCC=function(a){var r=t.get(this),s=new c.ControlChange({controllerType:a.number},r);return delete a.number,Object.assign(s,a),Array.isArray(this.controlChanges[s.number])||(this.controlChanges[s.number]=[]),(0,n.insert)(this.controlChanges[s.number],s,"ticks"),this},o.prototype.addPitchBend=function(a){var r=t.get(this),s=new f.PitchBend({},r);return Object.assign(s,a),(0,n.insert)(this.pitchBends,s,"ticks"),this},Object.defineProperty(o.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var a=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,r=0;r<this.notes.length-1;r++){var s=this.notes[r].time+this.notes[r].duration;a<s&&(a=s)}return a},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var a=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,r=0;r<this.notes.length-1;r++){var s=this.notes[r].ticks+this.notes[r].durationTicks;a<s&&(a=s)}return a},enumerable:!1,configurable:!0}),o.prototype.fromJSON=function(a){var r=this;this.name=a.name,this.channel=a.channel,this.instrument=new i.Instrument(void 0,this),this.instrument.fromJSON(a.instrument),a.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=a.endOfTrackTicks);for(var s in a.controlChanges)a.controlChanges[s]&&a.controlChanges[s].forEach(function(m){r.addCC({number:m.number,ticks:m.ticks,value:m.value})});a.notes.forEach(function(m){r.addNote({durationTicks:m.durationTicks,midi:m.midi,ticks:m.ticks,velocity:m.velocity})})},o.prototype.toJSON=function(){for(var a={},r=0;r<127;r++)this.controlChanges.hasOwnProperty(r)&&(a[r]=this.controlChanges[r].map(function(m){return m.toJSON()}));var s={channel:this.channel,controlChanges:a,pitchBends:this.pitchBends.map(function(m){return m.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(m){return m.toJSON()})};return this.endOfTrackTicks!==void 0&&(s.endOfTrackTicks=this.endOfTrackTicks),s},o})();return ee.Track=u,ee}var J={};function mt(n){var c=[];return Ve(n,c),c}function Ve(n,c){for(var l=0;l<n.length;l++){var f=n[l];Array.isArray(f)?Ve(f,c):c.push(f)}}const pt=Object.freeze(Object.defineProperty({__proto__:null,flatten:mt},Symbol.toStringTag,{value:"Module"})),gt=ot(pt);var Fe;function yt(){if(Fe)return J;Fe=1;var n=J&&J.__spreadArray||function(p,y,b){if(b||arguments.length===2)for(var h=0,x=y.length,S;h<x;h++)(S||!(h in y))&&(S||(S=Array.prototype.slice.call(y,0,h)),S[h]=y[h]);return p.concat(S||Array.prototype.slice.call(y))};Object.defineProperty(J,"__esModule",{value:!0}),J.encode=void 0;var c=$e(),l=ve(),f=gt;function i(p,y){return[{absoluteTime:p.ticks,channel:y,deltaTime:0,noteNumber:p.midi,type:"noteOn",velocity:Math.floor(p.velocity*127)},{absoluteTime:p.ticks+p.durationTicks,channel:y,deltaTime:0,noteNumber:p.midi,type:"noteOff",velocity:Math.floor(p.noteOffVelocity*127)}]}function e(p){return(0,f.flatten)(p.notes.map(function(y){return i(y,p.channel)}))}function t(p,y){return{absoluteTime:p.ticks,channel:y,controllerType:p.number,deltaTime:0,type:"controller",value:Math.floor(p.value*127)}}function u(p){for(var y=[],b=0;b<127;b++)p.controlChanges.hasOwnProperty(b)&&p.controlChanges[b].forEach(function(h){y.push(t(h,p.channel))});return y}function o(p,y){return{absoluteTime:p.ticks,channel:y,deltaTime:0,type:"pitchBend",value:p.value}}function a(p){var y=[];return p.pitchBends.forEach(function(b){y.push(o(b,p.channel))}),y}function r(p){return{absoluteTime:0,channel:p.channel,deltaTime:0,programNumber:p.instrument.number,type:"programChange"}}function s(p){return{absoluteTime:0,deltaTime:0,meta:!0,text:p,type:"trackName"}}function m(p){return{absoluteTime:p.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/p.bpm),type:"setTempo"}}function d(p){return{absoluteTime:p.ticks,deltaTime:0,denominator:p.timeSignature[1],meta:!0,metronome:24,numerator:p.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function I(p){var y=l.keySignatureKeys.indexOf(p.key);return{absoluteTime:p.ticks,deltaTime:0,key:y+7,meta:!0,scale:p.scale==="major"?0:1,type:"keySignature"}}function k(p){return{absoluteTime:p.ticks,deltaTime:0,meta:!0,text:p.text,type:p.type}}function g(p){var y={header:{format:1,numTracks:p.tracks.length+1,ticksPerBeat:p.header.ppq},tracks:n([n(n(n(n([{absoluteTime:0,deltaTime:0,meta:!0,text:p.header.name,type:"trackName"}],p.header.keySignatures.map(function(b){return I(b)}),!0),p.header.meta.map(function(b){return k(b)}),!0),p.header.tempos.map(function(b){return m(b)}),!0),p.header.timeSignatures.map(function(b){return d(b)}),!0)],p.tracks.map(function(b){return n(n(n([s(b.name),r(b)],e(b),!0),u(b),!0),a(b),!0)}),!0)};return y.tracks=y.tracks.map(function(b){b=b.sort(function(x,S){return x.absoluteTime-S.absoluteTime});var h=0;return b.forEach(function(x){x.deltaTime=x.absoluteTime-h,h=x.absoluteTime,delete x.absoluteTime}),b.push({deltaTime:0,meta:!0,type:"endOfTrack"}),b}),new Uint8Array((0,c.writeMidi)(y))}return J.encode=g,J}var _e;function bt(){return _e||(_e=1,(function(n){var c=V&&V.__awaiter||function(s,m,d,I){function k(g){return g instanceof d?g:new d(function(p){p(g)})}return new(d||(d=Promise))(function(g,p){function y(x){try{h(I.next(x))}catch(S){p(S)}}function b(x){try{h(I.throw(x))}catch(S){p(S)}}function h(x){x.done?g(x.value):k(x.value).then(y,b)}h((I=I.apply(s,m||[])).next())})},l=V&&V.__generator||function(s,m){var d={label:0,sent:function(){if(g[0]&1)throw g[1];return g[1]},trys:[],ops:[]},I,k,g,p;return p={next:y(0),throw:y(1),return:y(2)},typeof Symbol=="function"&&(p[Symbol.iterator]=function(){return this}),p;function y(h){return function(x){return b([h,x])}}function b(h){if(I)throw new TypeError("Generator is already executing.");for(;d;)try{if(I=1,k&&(g=h[0]&2?k.return:h[0]?k.throw||((g=k.return)&&g.call(k),0):k.next)&&!(g=g.call(k,h[1])).done)return g;switch(k=0,g&&(h=[h[0]&2,g.value]),h[0]){case 0:case 1:g=h;break;case 4:return d.label++,{value:h[1],done:!1};case 5:d.label++,k=h[1],h=[0];continue;case 7:h=d.ops.pop(),d.trys.pop();continue;default:if(g=d.trys,!(g=g.length>0&&g[g.length-1])&&(h[0]===6||h[0]===2)){d=0;continue}if(h[0]===3&&(!g||h[1]>g[0]&&h[1]<g[3])){d.label=h[1];break}if(h[0]===6&&d.label<g[1]){d.label=g[1],g=h;break}if(g&&d.label<g[2]){d.label=g[2],d.ops.push(h);break}g[2]&&d.ops.pop(),d.trys.pop();continue}h=m.call(s,d)}catch(x){h=[6,x],k=0}finally{I=g=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}};Object.defineProperty(n,"__esModule",{value:!0}),n.Header=n.Track=n.Midi=void 0;var f=$e(),i=ve(),e=Pe(),t=yt(),u=(function(){function s(m){var d=this,I=null;if(m){var k=m instanceof ArrayBuffer?new Uint8Array(m):m;I=(0,f.parseMidi)(k),I.tracks.forEach(function(g){var p=0;g.forEach(function(y){p+=y.deltaTime,y.absoluteTime=p})}),I.tracks=r(I.tracks)}this.header=new i.Header(I),this.tracks=[],m&&(this.tracks=I.tracks.map(function(g){return new e.Track(g,d.header)}),I.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return s.fromUrl=function(m){return c(this,void 0,void 0,function(){var d,I;return l(this,function(k){switch(k.label){case 0:return[4,fetch(m)];case 1:return d=k.sent(),d.ok?[4,d.arrayBuffer()]:[3,3];case 2:return I=k.sent(),[2,new s(I)];case 3:throw new Error("Could not load '".concat(m,"'"))}})})},Object.defineProperty(s.prototype,"name",{get:function(){return this.header.name},set:function(m){this.header.name=m},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"duration",{get:function(){var m=this.tracks.map(function(d){return d.duration});return Math.max.apply(Math,m)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"durationTicks",{get:function(){var m=this.tracks.map(function(d){return d.durationTicks});return Math.max.apply(Math,m)},enumerable:!1,configurable:!0}),s.prototype.addTrack=function(){var m=new e.Track(void 0,this.header);return this.tracks.push(m),m},s.prototype.toArray=function(){return(0,t.encode)(this)},s.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(m){return m.toJSON()})}},s.prototype.fromJSON=function(m){var d=this;this.header=new i.Header,this.header.fromJSON(m.header),this.tracks=m.tracks.map(function(I){var k=new e.Track(void 0,d.header);return k.fromJSON(I),k})},s.prototype.clone=function(){var m=new s;return m.fromJSON(this.toJSON()),m},s})();n.Midi=u;var o=Pe();Object.defineProperty(n,"Track",{enumerable:!0,get:function(){return o.Track}});var a=ve();Object.defineProperty(n,"Header",{enumerable:!0,get:function(){return a.Header}});function r(s){for(var m=[],d=0;d<s.length;d++)for(var I=m.length,k=new Map,g=Array(16).fill(0),p=0,y=s[d];p<y.length;p++){var b=y[p],h=I,x=b.channel;if(x!==void 0){b.type==="programChange"&&(g[x]=b.programNumber);var S=g[x],K="".concat(S," ").concat(x);k.has(K)?h=k.get(K):(h=I+k.size,k.set(K,h))}m[h]||m.push([]),m[h].push(b)}return m}})(V)),V}var He=bt();const fe="midiRecordings";let X=null,_=[],q=[],B=null,F=null,oe="default",U=!1,M=!1,Ie=0,v=[],E=null,ue=null,Le=[],$=0,w=0,R=null,C={},O=null,le=!0,Z=null;const vt=500;let W=[],ae=null;const It=document.getElementById("status-bar"),De=document.getElementById("midi-indicator"),be=document.getElementById("toggle-devices-button"),kt=document.getElementById("device-settings-title"),xt=document.getElementById("device-selectors-container"),z=document.getElementById("midi-input"),G=document.getElementById("midi-output"),de=document.getElementById("output-channel"),Q=document.getElementById("record-button"),Y=document.getElementById("play-button"),Je=document.getElementById("save-button"),We=document.getElementById("export-button"),Tt=document.getElementById("import-midi-input"),D=document.getElementById("saved-recordings"),ze=document.getElementById("load-button"),Ge=document.getElementById("rename-button"),Ke=document.getElementById("delete-button"),wt=document.getElementById("playback-card"),j=document.getElementById("time-display"),A=document.getElementById("playback-slider"),qe=document.getElementById("auto-record-checkbox");function T(n){It.textContent=n}function Qe(){De.classList.add("active"),setTimeout(()=>{De.classList.remove("active")},150)}function Ye(){const n=B&&_.some(c=>c.id===B);kt.textContent=`${n?"✔️":"❌"} MIDI Device Settings`}function Ut(){const n=B,c=F;z.innerHTML="",_.length===0?z.innerHTML='<option value="">No input devices found</option>':(z.innerHTML='<option value="">Select an input...</option>',_.forEach(l=>{const f=document.createElement("option");f.value=l.id,f.textContent=l.name??"Unknown Input",z.appendChild(f)})),z.value=n??"",G.innerHTML="",q.length===0?G.innerHTML='<option value="">No output devices found</option>':(G.innerHTML='<option value="">Select an output...</option>',q.forEach(l=>{const f=document.createElement("option");f.value=l.id,f.textContent=l.name??"Unknown Output",G.appendChild(f)})),G.value=c??"",Ye(),P()}function he(){D.innerHTML="";const n=Object.keys(C);n.length===0&&(D.innerHTML="<option>No saved recordings</option>"),n.forEach(c=>{const l=document.createElement("option");l.value=c,l.textContent=c,D.appendChild(l)}),O&&C[O]?D.value=O:n.length>0?(O=n[0],D.value=O):O=null,P()}function P(){const n=v.some(l=>l.data.length===3&&(l.data[0]&240)===144&&l.data[2]>0),c=B&&_.some(l=>l.id===B);Q.disabled=M||!c,Y.disabled=U||!n,Je.disabled=U||M||!n,We.disabled=U||M||!n,ze.disabled=U||M||!O,Ge.disabled=U||M||!O,Ke.disabled=U||M||!O,U?(Q.classList.add("recording"),Q.textContent="Stop"):(Q.classList.remove("recording"),Q.textContent="Record"),M?(Y.classList.add("playing"),Y.textContent="Stop"):(Y.classList.remove("playing"),Y.textContent="Play"),wt.style.display=n?"block":"none"}function N(n){const c=Math.floor(n/60),l=Math.floor(n%60);return`${String(c).padStart(2,"0")}:${String(l).padStart(2,"0")}`}function Xe(){if(!M){R&&clearInterval(R),R=null;return}const n=(performance.now()-Ie+$)/1e3,c=Math.min(n,w);A.value=String(w>0?c/w*100:0),j.textContent=`${N(c)} / ${N(w)}`,c>=w&&w>0&&se()}function Ze(){if(M||v.length===0)return;const n=q.find(f=>f.id===F);if(!n){T("Error: No output device selected for playback.");return}M=!0,Ie=performance.now(),T(`Playing back recording: ${E??"Current Recording"}`),P(),it(),R&&clearInterval(R),R=setInterval(Xe,100);const c=v[0].timestamp;w=(v[v.length-1].timestamp-c)/1e3;const l=f=>{if(M)for(let i=f;i<v.length;i++){const e=v[i],t=e.timestamp-c;if(t<$)continue;if(t-(performance.now()-Ie+$)>20){ue=setTimeout(()=>l(i),20);return}const[o,a,r]=e.data;let s;oe!=="default"?s=[o&240|parseInt(oe,10)-1,a,r]:s=[o,a,r],console.log("Sending MIDI message:",s),n.send(s),(o&240)===144&&r>0&&Qe()}};l(0)}function se(n=!1){if(!M)return;M=!1,ue&&(clearTimeout(ue),ue=null),Le.forEach(clearTimeout),Le=[],R&&(clearInterval(R),R=null);const c=q.find(l=>l.id===F);if(c)for(let l=0;l<16;l++)c.send([176+l,123,0]);n||($=0,Xe(),A.value="0",j.textContent=`${N(0)} / ${N(w)}`),T("Playback stopped."),P(),at()}function St(n){if(v.length===0)return;const c=M;c&&se(!0);const l=v[0].timestamp;w=(v[v.length-1].timestamp-l)/1e3,$=w*n/100*1e3;const f=$/1e3;j.textContent=`${N(f)} / ${N(w)}`,c&&Ze()}function Ct(){U?tt():et()}function et(){U||!B||(v=[],E=null,U=!0,performance.now(),T("Recording..."),P(),it(),w=0,$=0,A.value="0",j.textContent="00:00 / 00:00")}function tt(){if(U){if(U=!1,v.length>0){const n=v[0].timestamp;v.forEach(c=>c.timestamp-=n),w=v[v.length-1].timestamp/1e3}else w=0;T(`Recording finished. Length: ${w.toFixed(1)}s.`),P(),at(),j.textContent=`${N(0)} / ${N(w)}`}}function Mt(){if(v.length===0){T("Nothing to save.");return}const n=prompt("Enter a name for this recording:",E??`Recording ${new Date().toLocaleString()}`);n&&(C[n]=[...v],E=n,O=n,localStorage.setItem(fe,JSON.stringify(C)),T(`Recording saved as "${n}".`),he())}function Ot(){if(U)return;const n=D.value;n&&C[n]&&(se(),v=[...C[n]],E=n,O=n,T(`Loaded recording: "${n}".`),v.length>0?w=v[v.length-1].timestamp/1e3:w=0,$=0,A.value="0",j.textContent=`${N(0)} / ${N(w)}`,P())}function Bt(){const n=O;if(!n||!C[n]){T("No recording selected to rename.");return}const c=prompt(`Enter a new name for "${n}":`,n);if(c&&c!==n){if(C[c]){T(`Error: A recording named "${c}" already exists.`);return}C[c]=C[n],delete C[n],O=c,E===n&&(E=c),localStorage.setItem(fe,JSON.stringify(C)),T(`Renamed "${n}" to "${c}".`),he()}}function Et(){const n=D.value;n&&C[n]&&confirm(`Are you sure you want to delete "${n}"?`)&&(delete C[n],localStorage.setItem(fe,JSON.stringify(C)),T(`Deleted recording: "${n}".`),E===n&&(v=[],E=null,w=0,j.textContent="00:00 / 00:00",A.value="0"),O=null,he())}function Nt(){if(v.length===0){T("No recording to export.");return}try{const n=new He.Midi,c=n.addTrack();if(v.length>0){let u=0;v.forEach(o=>{const[a,r,s]=o.data,m=a&240,d=(o.timestamp-u)/1e3;switch(m){case 144:c.addNote({midi:r,time:d,velocity:s/127,duration:0});break;case 128:c.addNote({midi:r,time:d,velocity:0,duration:0});break;case 176:c.addCC({number:r,value:s/127,time:d});break}u=o.timestamp})}const l=n.toArray(),f=new Blob([l],{type:"audio/midi"}),i=URL.createObjectURL(f),e=document.createElement("a");e.href=i;const t=E?`${E}.mid`:`midi-recording-${Date.now()}.mid`;e.download=t,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(i),T(`Exported as ${t}`)}catch(n){console.error("Failed to export MIDI:",n),T("Error: Failed to export MIDI file.")}}async function Pt(n){try{const c=await n.arrayBuffer(),l=new He.Midi(c);if(l.tracks.length===0){T("Error: MIDI file has no tracks.");return}se(),v=[];let f=[];l.tracks.forEach(i=>{i.notes.forEach(e=>{f.push({...e,startTime:e.time,endTime:e.time+e.duration})})}),f.sort((i,e)=>i.startTime-e.startTime),f.forEach(i=>{v.push({data:[144|i.channel,i.midi,Math.round(i.velocity*127)],timestamp:i.startTime*1e3}),v.push({data:[128|i.channel,i.midi,0],timestamp:i.endTime*1e3})}),v.sort((i,e)=>i.timestamp-e.timestamp),v.length>0?w=v[v.length-1].timestamp/1e3:w=0,E=n.name.replace(/\.(mid|midi)$/i,""),T(`Imported: ${n.name}`),P(),$=0,A.value="0",j.textContent=`${N(0)} / ${N(w)}`}catch(c){console.error("Failed to import MIDI:",c),T("Error: Could not parse MIDI file.")}}function Ft(n){X=n,X.onstatechange=_t,T("MIDI ready. Select input/output devices."),rt()}function Re(n){T(`Failed to get MIDI access - ${n}`),console.error(`Failed to get MIDI access - ${n}`)}function _t(){rt()}function rt(){X&&(_=Array.from(X.inputs.values()),q=Array.from(X.outputs.values()),B&&!_.some(n=>n.id===B)&&(B=null),F&&!q.some(n=>n.id===F)&&(F=null),!B&&_.length>0&&(B=_[0].id),!F&&q.length>0&&(F=q[0].id),Ut(),nt())}function nt(){if(!X)return;_.forEach(c=>{c.onmidimessage=null});const n=_.find(c=>c.id===B);n?(T(`Listening to ${n.name}...`),n.onmidimessage=Lt):T("No input device selected.")}function Lt(n){const c=Array.from(n.data),[l,f,i]=c,e=q.find(a=>a.id===F);if(e){let a;oe!=="default"?a=[l&240|parseInt(oe,10)-1,f,i]:a=c,e.send(a)}const t=(l&240)===144&&i>0,u=(l&240)===128||(l&240)===144&&i===0;t&&Qe(),le&&t&&!U&&et(),le&&U&&(t||u)&&(Z&&clearTimeout(Z),Z=setTimeout(()=>{U&&(T("Silence detected, stopping auto-record."),tt())},3e3));const o=performance.now();for(W.push({data:c,timestamp:o});W.length>0&&o-W[0].timestamp>vt;)W.shift();U&&(v.length===0&&(v.push(...W),W.length>0?W[0].timestamp:performance.now()),v.push({data:c,timestamp:o}))}async function it(){if("wakeLock"in navigator)try{ae=await navigator.wakeLock.request("screen"),ae.addEventListener("release",()=>{})}catch(n){console.error(`${n.name}, ${n.message}`),T("Warning: Could not acquire screen wake lock.")}}async function at(){ae&&(await ae.release(),ae=null)}function Dt(){be.addEventListener("click",()=>{const n=be.getAttribute("aria-expanded")==="true";be.setAttribute("aria-expanded",String(!n)),xt.classList.toggle("expanded")}),z.addEventListener("change",()=>{B=z.value||null,nt(),Ye(),P()}),G.addEventListener("change",()=>{F=G.value||null}),de.addEventListener("change",()=>{oe=de.value}),Q.addEventListener("click",Ct),Y.addEventListener("click",()=>{M?se():Ze()}),Je.addEventListener("click",Mt),We.addEventListener("click",Nt),Tt.addEventListener("change",n=>{var l;const c=(l=n.target.files)==null?void 0:l[0];c&&(Pt(c),n.target.value="")}),D.addEventListener("change",()=>{O=D.value,P()}),ze.addEventListener("click",Ot),Ge.addEventListener("click",Bt),Ke.addEventListener("click",Et),A.addEventListener("input",()=>{St(parseInt(A.value,10))}),qe.addEventListener("change",()=>{le=qe.checked,!le&&Z&&(clearTimeout(Z),Z=null)})}function qt(){de.innerHTML='<option value="default">Default (Passthrough)</option>';for(let c=1;c<=16;c++){const l=document.createElement("option");l.value=String(c-1),l.textContent=`Channel ${c}`,de.appendChild(l)}const n=localStorage.getItem(fe);if(n)try{C=JSON.parse(n)}catch(c){console.error("Could not parse saved recordings:",c)}he(),navigator.requestMIDIAccess?navigator.requestMIDIAccess({sysex:!1}).then(Ft,()=>Re("Permission denied or system error.")):Re("Web MIDI API not supported in this browser."),Dt(),P(),j.textContent="00:00 / 00:00"}qt();
