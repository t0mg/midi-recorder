(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const e of n)if(e.type==="childList")for(const t of e.addedNodes)t.tagName==="LINK"&&t.rel==="modulepreload"&&s(t)}).observe(document,{childList:!0,subtree:!0});function d(n){const e={};return n.integrity&&(e.integrity=n.integrity),n.referrerPolicy&&(e.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?e.credentials="include":n.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(n){if(n.ep)return;n.ep=!0;const e=d(n);fetch(n.href,e)}})();function lt(r){if(Object.prototype.hasOwnProperty.call(r,"__esModule"))return r;var l=r.default;if(typeof l=="function"){var d=function s(){return this instanceof s?Reflect.construct(l,arguments,this.constructor):l.apply(this,arguments)};d.prototype=l.prototype}else d={};return Object.defineProperty(d,"__esModule",{value:!0}),Object.keys(r).forEach(function(s){var n=Object.getOwnPropertyDescriptor(r,s);Object.defineProperty(d,s,n.get?n:{enumerable:!0,get:function(){return r[s]}})}),d}var J={},fe={},ge,Te;function dt(){if(Te)return ge;Te=1;function r(n){var e=new s(n),t=e.readChunk();if(t.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+t.id+"'";for(var u=l(t.data),o=[],a=0;!e.eof()&&a<u.numTracks;a++){var i=e.readChunk();if(i.id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+i.id+"'";var c=d(i.data);o.push(c)}return{header:u,tracks:o}}function l(n){var e=new s(n),t=e.readUInt16(),u=e.readUInt16(),o={format:t,numTracks:u},a=e.readUInt16();return a&32768?(o.framesPerSecond=256-(a>>8),o.ticksPerFrame=a&255):o.ticksPerBeat=a,o}function d(n){for(var e=new s(n),t=[];!e.eof();){var u=a();t.push(u)}return t;var o;function a(){var i={};i.deltaTime=e.readVarInt();var c=e.readUInt8();if((c&240)===240)if(c===255){i.meta=!0;var m=e.readUInt8(),f=e.readVarInt();switch(m){case 0:if(i.type="sequenceNumber",f!==2)throw"Expected length for sequenceNumber event is 2, got "+f;return i.number=e.readUInt16(),i;case 1:return i.type="text",i.text=e.readString(f),i;case 2:return i.type="copyrightNotice",i.text=e.readString(f),i;case 3:return i.type="trackName",i.text=e.readString(f),i;case 4:return i.type="instrumentName",i.text=e.readString(f),i;case 5:return i.type="lyrics",i.text=e.readString(f),i;case 6:return i.type="marker",i.text=e.readString(f),i;case 7:return i.type="cuePoint",i.text=e.readString(f),i;case 32:if(i.type="channelPrefix",f!=1)throw"Expected length for channelPrefix event is 1, got "+f;return i.channel=e.readUInt8(),i;case 33:if(i.type="portPrefix",f!=1)throw"Expected length for portPrefix event is 1, got "+f;return i.port=e.readUInt8(),i;case 47:if(i.type="endOfTrack",f!=0)throw"Expected length for endOfTrack event is 0, got "+f;return i;case 81:if(i.type="setTempo",f!=3)throw"Expected length for setTempo event is 3, got "+f;return i.microsecondsPerBeat=e.readUInt24(),i;case 84:if(i.type="smpteOffset",f!=5)throw"Expected length for smpteOffset event is 5, got "+f;var I=e.readUInt8(),k={0:24,32:25,64:29,96:30};return i.frameRate=k[I&96],i.hour=I&31,i.min=e.readUInt8(),i.sec=e.readUInt8(),i.frame=e.readUInt8(),i.subFrame=e.readUInt8(),i;case 88:if(i.type="timeSignature",f!=2&&f!=4)throw"Expected length for timeSignature event is 4 or 2, got "+f;return i.numerator=e.readUInt8(),i.denominator=1<<e.readUInt8(),f===4?(i.metronome=e.readUInt8(),i.thirtyseconds=e.readUInt8()):(i.metronome=36,i.thirtyseconds=8),i;case 89:if(i.type="keySignature",f!=2)throw"Expected length for keySignature event is 2, got "+f;return i.key=e.readInt8(),i.scale=e.readUInt8(),i;case 127:return i.type="sequencerSpecific",i.data=e.readBytes(f),i;default:return i.type="unknownMeta",i.data=e.readBytes(f),i.metatypeByte=m,i}}else if(c==240){i.type="sysEx";var f=e.readVarInt();return i.data=e.readBytes(f),i}else if(c==247){i.type="endSysEx";var f=e.readVarInt();return i.data=e.readBytes(f),i}else throw"Unrecognised MIDI event type byte: "+c;else{var g;if((c&128)===0){if(o===null)throw"Running status byte encountered before status byte";g=c,c=o,i.running=!0}else g=e.readUInt8(),o=c;var p=c>>4;switch(i.channel=c&15,p){case 8:return i.type="noteOff",i.noteNumber=g,i.velocity=e.readUInt8(),i;case 9:var y=e.readUInt8();return i.type=y===0?"noteOff":"noteOn",i.noteNumber=g,i.velocity=y,y===0&&(i.byte9=!0),i;case 10:return i.type="noteAftertouch",i.noteNumber=g,i.amount=e.readUInt8(),i;case 11:return i.type="controller",i.controllerType=g,i.value=e.readUInt8(),i;case 12:return i.type="programChange",i.programNumber=g,i;case 13:return i.type="channelAftertouch",i.amount=g,i;case 14:return i.type="pitchBend",i.value=g+(e.readUInt8()<<7)-8192,i;default:throw"Unrecognised MIDI event type: "+p}}}}function s(n){this.buffer=n,this.bufferLen=this.buffer.length,this.pos=0}return s.prototype.eof=function(){return this.pos>=this.bufferLen},s.prototype.readUInt8=function(){var n=this.buffer[this.pos];return this.pos+=1,n},s.prototype.readInt8=function(){var n=this.readUInt8();return n&128?n-256:n},s.prototype.readUInt16=function(){var n=this.readUInt8(),e=this.readUInt8();return(n<<8)+e},s.prototype.readInt16=function(){var n=this.readUInt16();return n&32768?n-65536:n},s.prototype.readUInt24=function(){var n=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8();return(n<<16)+(e<<8)+t},s.prototype.readInt24=function(){var n=this.readUInt24();return n&8388608?n-16777216:n},s.prototype.readUInt32=function(){var n=this.readUInt8(),e=this.readUInt8(),t=this.readUInt8(),u=this.readUInt8();return(n<<24)+(e<<16)+(t<<8)+u},s.prototype.readBytes=function(n){var e=this.buffer.slice(this.pos,this.pos+n);return this.pos+=n,e},s.prototype.readString=function(n){var e=this.readBytes(n);return String.fromCharCode.apply(null,e)},s.prototype.readVarInt=function(){for(var n=0;!this.eof();){var e=this.readUInt8();if(e&128)n+=e&127,n<<=7;else return n+e}return n},s.prototype.readChunk=function(){var n=this.readString(4),e=this.readUInt32(),t=this.readBytes(e);return{id:n,length:e,data:t}},ge=r,ge}var ye,we;function ft(){if(we)return ye;we=1;function r(e,t){if(typeof e!="object")throw"Invalid MIDI data";t=t||{};var u=e.header||{},o=e.tracks||[],a,i=o.length,c=new n;for(l(c,u,i),a=0;a<i;a++)d(c,o[a],t);return c.buffer}function l(e,t,u){var o=t.format==null?1:t.format,a=128;t.timeDivision?a=t.timeDivision:t.ticksPerFrame&&t.framesPerSecond?a=-(t.framesPerSecond&255)<<8|t.ticksPerFrame&255:t.ticksPerBeat&&(a=t.ticksPerBeat&32767);var i=new n;i.writeUInt16(o),i.writeUInt16(u),i.writeUInt16(a),e.writeChunk("MThd",i.buffer)}function d(e,t,u){var o=new n,a,i=t.length,c=null;for(a=0;a<i;a++)(u.running===!1||!u.running&&!t[a].running)&&(c=null),c=s(o,t[a],c,u.useByte9ForNoteOff);e.writeChunk("MTrk",o.buffer)}function s(e,t,u,o){var a=t.type,i=t.deltaTime,c=t.text||"",m=t.data||[],f=null;switch(e.writeVarInt(i),a){case"sequenceNumber":e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(t.number);break;case"text":e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(c.length),e.writeString(c);break;case"copyrightNotice":e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(c.length),e.writeString(c);break;case"trackName":e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(c.length),e.writeString(c);break;case"instrumentName":e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(c.length),e.writeString(c);break;case"lyrics":e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(c.length),e.writeString(c);break;case"marker":e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(c.length),e.writeString(c);break;case"cuePoint":e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(c.length),e.writeString(c);break;case"channelPrefix":e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(t.channel);break;case"portPrefix":e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(t.port);break;case"endOfTrack":e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case"setTempo":e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(t.microsecondsPerBeat);break;case"smpteOffset":e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5);var I={24:0,25:32,29:64,30:96},k=t.hour&31|I[t.frameRate];e.writeUInt8(k),e.writeUInt8(t.min),e.writeUInt8(t.sec),e.writeUInt8(t.frame),e.writeUInt8(t.subFrame);break;case"timeSignature":e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(t.numerator);var g=Math.floor(Math.log(t.denominator)/Math.LN2)&255;e.writeUInt8(g),e.writeUInt8(t.metronome),e.writeUInt8(t.thirtyseconds||8);break;case"keySignature":e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(t.key),e.writeUInt8(t.scale);break;case"sequencerSpecific":e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(m.length),e.writeBytes(m);break;case"unknownMeta":t.metatypeByte!=null&&(e.writeUInt8(255),e.writeUInt8(t.metatypeByte),e.writeVarInt(m.length),e.writeBytes(m));break;case"sysEx":e.writeUInt8(240),e.writeVarInt(m.length),e.writeBytes(m);break;case"endSysEx":e.writeUInt8(247),e.writeVarInt(m.length),e.writeBytes(m);break;case"noteOff":var p=o!==!1&&t.byte9||o&&t.velocity==0?144:128;f=p|t.channel,f!==u&&e.writeUInt8(f),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteOn":f=144|t.channel,f!==u&&e.writeUInt8(f),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteAftertouch":f=160|t.channel,f!==u&&e.writeUInt8(f),e.writeUInt8(t.noteNumber),e.writeUInt8(t.amount);break;case"controller":f=176|t.channel,f!==u&&e.writeUInt8(f),e.writeUInt8(t.controllerType),e.writeUInt8(t.value);break;case"programChange":f=192|t.channel,f!==u&&e.writeUInt8(f),e.writeUInt8(t.programNumber);break;case"channelAftertouch":f=208|t.channel,f!==u&&e.writeUInt8(f),e.writeUInt8(t.amount);break;case"pitchBend":f=224|t.channel,f!==u&&e.writeUInt8(f);var y=8192+t.value,b=y&127,h=y>>7&127;e.writeUInt8(b),e.writeUInt8(h);break;default:throw"Unrecognized event type: "+a}return f}function n(){this.buffer=[]}return n.prototype.writeUInt8=function(e){this.buffer.push(e&255)},n.prototype.writeInt8=n.prototype.writeUInt8,n.prototype.writeUInt16=function(e){var t=e>>8&255,u=e&255;this.writeUInt8(t),this.writeUInt8(u)},n.prototype.writeInt16=n.prototype.writeUInt16,n.prototype.writeUInt24=function(e){var t=e>>16&255,u=e>>8&255,o=e&255;this.writeUInt8(t),this.writeUInt8(u),this.writeUInt8(o)},n.prototype.writeInt24=n.prototype.writeUInt24,n.prototype.writeUInt32=function(e){var t=e>>24&255,u=e>>16&255,o=e>>8&255,a=e&255;this.writeUInt8(t),this.writeUInt8(u),this.writeUInt8(o),this.writeUInt8(a)},n.prototype.writeInt32=n.prototype.writeUInt32,n.prototype.writeBytes=function(e){this.buffer=this.buffer.concat(Array.prototype.slice.call(e,0))},n.prototype.writeString=function(e){var t,u=e.length,o=[];for(t=0;t<u;t++)o.push(e.codePointAt(t));this.writeBytes(o)},n.prototype.writeVarInt=function(e){if(e<0)throw"Cannot write negative variable-length integer";if(e<=127)this.writeUInt8(e);else{var t=e,u=[];for(u.push(t&127),t>>=7;t;){var o=t&127|128;u.push(o),t>>=7}this.writeBytes(u.reverse())}},n.prototype.writeChunk=function(e,t){this.writeString(e),this.writeUInt32(t.length),this.writeBytes(t)},ye=r,ye}var Se;function $e(){return Se||(Se=1,fe.parseMidi=dt(),fe.writeMidi=ft()),fe}var be={},W={},Ue;function je(){if(Ue)return W;Ue=1,Object.defineProperty(W,"__esModule",{value:!0}),W.insert=W.search=void 0;function r(d,s,n){n===void 0&&(n="ticks");var e=0,t=d.length,u=t;if(t>0&&d[t-1][n]<=s)return t-1;for(;e<u;){var o=Math.floor(e+(u-e)/2),a=d[o],i=d[o+1];if(a[n]===s){for(var c=o;c<d.length;c++){var m=d[c];m[n]===s&&(o=c)}return o}else{if(a[n]<s&&i[n]>s)return o;a[n]>s?u=o:a[n]<s&&(e=o+1)}}return-1}W.search=r;function l(d,s,n){if(n===void 0&&(n="ticks"),d.length){var e=r(d,s[n],n);d.splice(e+1,0,s)}else d.push(s)}return W.insert=l,W}var Ce;function Ie(){return Ce||(Ce=1,(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.Header=r.keySignatureKeys=void 0;var l=je(),d=new WeakMap;r.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"];var s=(function(){function n(e){var t=this;if(this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",d.set(this,480),e){d.set(this,e.header.ticksPerBeat),e.tracks.forEach(function(o){o.forEach(function(a){a.meta&&(a.type==="timeSignature"?t.timeSignatures.push({ticks:a.absoluteTime,timeSignature:[a.numerator,a.denominator]}):a.type==="setTempo"?t.tempos.push({bpm:6e7/a.microsecondsPerBeat,ticks:a.absoluteTime}):a.type==="keySignature"&&t.keySignatures.push({key:r.keySignatureKeys[a.key+7],scale:a.scale===0?"major":"minor",ticks:a.absoluteTime}))})});var u=0;e.tracks[0].forEach(function(o){u+=o.deltaTime,o.meta&&(o.type==="trackName"?t.name=o.text:(o.type==="text"||o.type==="cuePoint"||o.type==="marker"||o.type==="lyrics")&&t.meta.push({text:o.text,ticks:u,type:o.type}))}),this.update()}}return n.prototype.update=function(){var e=this,t=0,u=0;this.tempos.sort(function(o,a){return o.ticks-a.ticks}),this.tempos.forEach(function(o,a){var i=a>0?e.tempos[a-1].bpm:e.tempos[0].bpm,c=o.ticks/e.ppq-u,m=60/i*c;o.time=m+t,t=o.time,u+=c}),this.timeSignatures.sort(function(o,a){return o.ticks-a.ticks}),this.timeSignatures.forEach(function(o,a){var i=a>0?e.timeSignatures[a-1]:e.timeSignatures[0],c=(o.ticks-i.ticks)/e.ppq,m=c/i.timeSignature[0]/(i.timeSignature[1]/4);i.measures=i.measures||0,o.measures=m+i.measures})},n.prototype.ticksToSeconds=function(e){var t=(0,l.search)(this.tempos,e);if(t!==-1){var u=this.tempos[t],o=u.time,a=(e-u.ticks)/this.ppq;return o+60/u.bpm*a}else{var i=e/this.ppq;return 60/120*i}},n.prototype.ticksToMeasures=function(e){var t=(0,l.search)(this.timeSignatures,e);if(t!==-1){var u=this.timeSignatures[t],o=(e-u.ticks)/this.ppq;return u.measures+o/(u.timeSignature[0]/u.timeSignature[1])/4}else return e/this.ppq/4},Object.defineProperty(n.prototype,"ppq",{get:function(){return d.get(this)},enumerable:!1,configurable:!0}),n.prototype.secondsToTicks=function(e){var t=(0,l.search)(this.tempos,e,"time");if(t!==-1){var u=this.tempos[t],o=u.time,a=e-o,i=a/(60/u.bpm);return Math.round(u.ticks+i*this.ppq)}else{var c=e/.5;return Math.round(c*this.ppq)}},n.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(e){return{bpm:e.bpm,ticks:e.ticks}}),timeSignatures:this.timeSignatures}},n.prototype.fromJSON=function(e){this.name=e.name,this.tempos=e.tempos.map(function(t){return Object.assign({},t)}),this.timeSignatures=e.timeSignatures.map(function(t){return Object.assign({},t)}),this.keySignatures=e.keySignatures.map(function(t){return Object.assign({},t)}),this.meta=e.meta.map(function(t){return Object.assign({},t)}),d.set(this,e.ppq),this.update()},n.prototype.setTempo=function(e){this.tempos=[{bpm:e,ticks:0}],this.update()},n})();r.Header=s})(be)),be}var re={},ve={},Oe;function Ve(){return Oe||(Oe=1,(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.ControlChange=r.controlChangeIds=r.controlChangeNames=void 0,r.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},r.controlChangeIds=Object.keys(r.controlChangeNames).reduce(function(n,e){return n[r.controlChangeNames[e]]=e,n},{});var l=new WeakMap,d=new WeakMap,s=(function(){function n(e,t){l.set(this,t),d.set(this,e.controllerType),this.ticks=e.absoluteTime,this.value=e.value}return Object.defineProperty(n.prototype,"number",{get:function(){return d.get(this)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"name",{get:function(){return r.controlChangeNames[this.number]?r.controlChangeNames[this.number]:null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"time",{get:function(){var e=l.get(this);return e.ticksToSeconds(this.ticks)},set:function(e){var t=l.get(this);this.ticks=t.secondsToTicks(e)},enumerable:!1,configurable:!0}),n.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},n})();r.ControlChange=s})(ve)),ve}var ne={},Me;function ht(){if(Me)return ne;Me=1,Object.defineProperty(ne,"__esModule",{value:!0}),ne.createControlChanges=void 0;var r=Ve();function l(){return new Proxy({},{get:function(d,s){if(d[s])return d[s];if(r.controlChangeIds.hasOwnProperty(s))return d[r.controlChangeIds[s]]},set:function(d,s,n){return r.controlChangeIds.hasOwnProperty(s)?d[r.controlChangeIds[s]]=n:d[s]=n,!0}})}return ne.createControlChanges=l,ne}var ie={},Ee;function mt(){if(Ee)return ie;Ee=1,Object.defineProperty(ie,"__esModule",{value:!0}),ie.PitchBend=void 0;var r=new WeakMap,l=(function(){function d(s,n){r.set(this,n),this.ticks=s.absoluteTime,this.value=s.value}return Object.defineProperty(d.prototype,"time",{get:function(){var s=r.get(this);return s.ticksToSeconds(this.ticks)},set:function(s){var n=r.get(this);this.ticks=n.secondsToTicks(s)},enumerable:!1,configurable:!0}),d.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},d})();return ie.PitchBend=l,ie}var ae={},L={},Be;function pt(){return Be||(Be=1,Object.defineProperty(L,"__esModule",{value:!0}),L.DrumKitByPatchID=L.InstrumentFamilyByID=L.instrumentByPatchID=void 0,L.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],L.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],L.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"}),L}var Ne;function gt(){if(Ne)return ae;Ne=1,Object.defineProperty(ae,"__esModule",{value:!0}),ae.Instrument=void 0;var r=pt(),l=new WeakMap,d=(function(){function s(n,e){if(this.number=0,l.set(this,e),this.number=0,n){var t=n.find(function(u){return u.type==="programChange"});t&&(this.number=t.programNumber)}}return Object.defineProperty(s.prototype,"name",{get:function(){return this.percussion?r.DrumKitByPatchID[this.number]:r.instrumentByPatchID[this.number]},set:function(n){var e=r.instrumentByPatchID.indexOf(n);e!==-1&&(this.number=e)},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"family",{get:function(){return this.percussion?"drums":r.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:!1,configurable:!0}),Object.defineProperty(s.prototype,"percussion",{get:function(){var n=l.get(this);return n.channel===9},enumerable:!1,configurable:!0}),s.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},s.prototype.fromJSON=function(n){this.number=n.number},s})();return ae.Instrument=d,ae}var oe={},Pe;function yt(){if(Pe)return oe;Pe=1,Object.defineProperty(oe,"__esModule",{value:!0}),oe.Note=void 0;function r(t){var u=Math.floor(t/12)-1;return l(t)+u.toString()}function l(t){var u=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],o=t%12;return u[o]}function d(t){var u=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return u.indexOf(t)}var s=(function(){var t=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,u={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13};return function(o){var a=t.exec(o),i=a[1],c=a[2],m=u[i.toLowerCase()];return m+(parseInt(c,10)+1)*12}})(),n=new WeakMap,e=(function(){function t(u,o,a){n.set(this,a),this.midi=u.midi,this.velocity=u.velocity,this.noteOffVelocity=o.velocity,this.ticks=u.ticks,this.durationTicks=o.ticks-u.ticks}return Object.defineProperty(t.prototype,"name",{get:function(){return r(this.midi)},set:function(u){this.midi=s(u)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(u){var o=u-this.octave;this.midi+=o*12},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"pitch",{get:function(){return l(this.midi)},set:function(u){this.midi=12*(this.octave+1)+d(u)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"duration",{get:function(){var u=n.get(this);return u.ticksToSeconds(this.ticks+this.durationTicks)-u.ticksToSeconds(this.ticks)},set:function(u){var o=n.get(this),a=o.secondsToTicks(this.time+u);this.durationTicks=a-this.ticks},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"time",{get:function(){var u=n.get(this);return u.ticksToSeconds(this.ticks)},set:function(u){var o=n.get(this);this.ticks=o.secondsToTicks(u)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"bars",{get:function(){var u=n.get(this);return u.ticksToMeasures(this.ticks)},enumerable:!1,configurable:!0}),t.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},t})();return oe.Note=e,oe}var Fe;function _e(){if(Fe)return re;Fe=1,Object.defineProperty(re,"__esModule",{value:!0}),re.Track=void 0;var r=je(),l=Ve(),d=ht(),s=mt(),n=gt(),e=yt(),t=new WeakMap,u=(function(){function o(a,i){var c=this;if(this.name="",this.notes=[],this.controlChanges=(0,d.createControlChanges)(),this.pitchBends=[],t.set(this,i),a){var m=a.find(function(h){return h.type==="trackName"});this.name=m?m.text:""}if(this.instrument=new n.Instrument(a,this),this.channel=0,a){for(var f=a.filter(function(h){return h.type==="noteOn"}),I=a.filter(function(h){return h.type==="noteOff"}),k=function(){var h=f.shift();g.channel=h.channel;var x=I.findIndex(function(Q){return Q.noteNumber===h.noteNumber&&Q.absoluteTime>=h.absoluteTime});if(x!==-1){var C=I.splice(x,1)[0];g.addNote({durationTicks:C.absoluteTime-h.absoluteTime,midi:h.noteNumber,noteOffVelocity:C.velocity/127,ticks:h.absoluteTime,velocity:h.velocity/127})}},g=this;f.length;)k();var p=a.filter(function(h){return h.type==="controller"});p.forEach(function(h){c.addCC({number:h.controllerType,ticks:h.absoluteTime,value:h.value/127})});var y=a.filter(function(h){return h.type==="pitchBend"});y.forEach(function(h){c.addPitchBend({ticks:h.absoluteTime,value:h.value/Math.pow(2,13)})});var b=a.find(function(h){return h.type==="endOfTrack"});this.endOfTrackTicks=b!==void 0?b.absoluteTime:void 0}}return o.prototype.addNote=function(a){var i=t.get(this),c=new e.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},i);return Object.assign(c,a),(0,r.insert)(this.notes,c,"ticks"),this},o.prototype.addCC=function(a){var i=t.get(this),c=new l.ControlChange({controllerType:a.number},i);return delete a.number,Object.assign(c,a),Array.isArray(this.controlChanges[c.number])||(this.controlChanges[c.number]=[]),(0,r.insert)(this.controlChanges[c.number],c,"ticks"),this},o.prototype.addPitchBend=function(a){var i=t.get(this),c=new s.PitchBend({},i);return Object.assign(c,a),(0,r.insert)(this.pitchBends,c,"ticks"),this},Object.defineProperty(o.prototype,"duration",{get:function(){if(!this.notes.length)return 0;for(var a=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,i=0;i<this.notes.length-1;i++){var c=this.notes[i].time+this.notes[i].duration;a<c&&(a=c)}return a},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"durationTicks",{get:function(){if(!this.notes.length)return 0;for(var a=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,i=0;i<this.notes.length-1;i++){var c=this.notes[i].ticks+this.notes[i].durationTicks;a<c&&(a=c)}return a},enumerable:!1,configurable:!0}),o.prototype.fromJSON=function(a){var i=this;this.name=a.name,this.channel=a.channel,this.instrument=new n.Instrument(void 0,this),this.instrument.fromJSON(a.instrument),a.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=a.endOfTrackTicks);for(var c in a.controlChanges)a.controlChanges[c]&&a.controlChanges[c].forEach(function(m){i.addCC({number:m.number,ticks:m.ticks,value:m.value})});a.notes.forEach(function(m){i.addNote({durationTicks:m.durationTicks,midi:m.midi,ticks:m.ticks,velocity:m.velocity})})},o.prototype.toJSON=function(){for(var a={},i=0;i<127;i++)this.controlChanges.hasOwnProperty(i)&&(a[i]=this.controlChanges[i].map(function(m){return m.toJSON()}));var c={channel:this.channel,controlChanges:a,pitchBends:this.pitchBends.map(function(m){return m.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(m){return m.toJSON()})};return this.endOfTrackTicks!==void 0&&(c.endOfTrackTicks=this.endOfTrackTicks),c},o})();return re.Track=u,re}var z={};function bt(r){var l=[];return He(r,l),l}function He(r,l){for(var d=0;d<r.length;d++){var s=r[d];Array.isArray(s)?He(s,l):l.push(s)}}const vt=Object.freeze(Object.defineProperty({__proto__:null,flatten:bt},Symbol.toStringTag,{value:"Module"})),It=lt(vt);var Le;function kt(){if(Le)return z;Le=1;var r=z&&z.__spreadArray||function(p,y,b){if(b||arguments.length===2)for(var h=0,x=y.length,C;h<x;h++)(C||!(h in y))&&(C||(C=Array.prototype.slice.call(y,0,h)),C[h]=y[h]);return p.concat(C||Array.prototype.slice.call(y))};Object.defineProperty(z,"__esModule",{value:!0}),z.encode=void 0;var l=$e(),d=Ie(),s=It;function n(p,y){return[{absoluteTime:p.ticks,channel:y,deltaTime:0,noteNumber:p.midi,type:"noteOn",velocity:Math.floor(p.velocity*127)},{absoluteTime:p.ticks+p.durationTicks,channel:y,deltaTime:0,noteNumber:p.midi,type:"noteOff",velocity:Math.floor(p.noteOffVelocity*127)}]}function e(p){return(0,s.flatten)(p.notes.map(function(y){return n(y,p.channel)}))}function t(p,y){return{absoluteTime:p.ticks,channel:y,controllerType:p.number,deltaTime:0,type:"controller",value:Math.floor(p.value*127)}}function u(p){for(var y=[],b=0;b<127;b++)p.controlChanges.hasOwnProperty(b)&&p.controlChanges[b].forEach(function(h){y.push(t(h,p.channel))});return y}function o(p,y){return{absoluteTime:p.ticks,channel:y,deltaTime:0,type:"pitchBend",value:p.value}}function a(p){var y=[];return p.pitchBends.forEach(function(b){y.push(o(b,p.channel))}),y}function i(p){return{absoluteTime:0,channel:p.channel,deltaTime:0,programNumber:p.instrument.number,type:"programChange"}}function c(p){return{absoluteTime:0,deltaTime:0,meta:!0,text:p,type:"trackName"}}function m(p){return{absoluteTime:p.ticks,deltaTime:0,meta:!0,microsecondsPerBeat:Math.floor(6e7/p.bpm),type:"setTempo"}}function f(p){return{absoluteTime:p.ticks,deltaTime:0,denominator:p.timeSignature[1],meta:!0,metronome:24,numerator:p.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}function I(p){var y=d.keySignatureKeys.indexOf(p.key);return{absoluteTime:p.ticks,deltaTime:0,key:y+7,meta:!0,scale:p.scale==="major"?0:1,type:"keySignature"}}function k(p){return{absoluteTime:p.ticks,deltaTime:0,meta:!0,text:p.text,type:p.type}}function g(p){var y={header:{format:1,numTracks:p.tracks.length+1,ticksPerBeat:p.header.ppq},tracks:r([r(r(r(r([{absoluteTime:0,deltaTime:0,meta:!0,text:p.header.name,type:"trackName"}],p.header.keySignatures.map(function(b){return I(b)}),!0),p.header.meta.map(function(b){return k(b)}),!0),p.header.tempos.map(function(b){return m(b)}),!0),p.header.timeSignatures.map(function(b){return f(b)}),!0)],p.tracks.map(function(b){return r(r(r([c(b.name),i(b)],e(b),!0),u(b),!0),a(b),!0)}),!0)};return y.tracks=y.tracks.map(function(b){b=b.sort(function(x,C){return x.absoluteTime-C.absoluteTime});var h=0;return b.forEach(function(x){x.deltaTime=x.absoluteTime-h,h=x.absoluteTime,delete x.absoluteTime}),b.push({deltaTime:0,meta:!0,type:"endOfTrack"}),b}),new Uint8Array((0,l.writeMidi)(y))}return z.encode=g,z}var Re;function xt(){return Re||(Re=1,(function(r){var l=J&&J.__awaiter||function(c,m,f,I){function k(g){return g instanceof f?g:new f(function(p){p(g)})}return new(f||(f=Promise))(function(g,p){function y(x){try{h(I.next(x))}catch(C){p(C)}}function b(x){try{h(I.throw(x))}catch(C){p(C)}}function h(x){x.done?g(x.value):k(x.value).then(y,b)}h((I=I.apply(c,m||[])).next())})},d=J&&J.__generator||function(c,m){var f={label:0,sent:function(){if(g[0]&1)throw g[1];return g[1]},trys:[],ops:[]},I,k,g,p;return p={next:y(0),throw:y(1),return:y(2)},typeof Symbol=="function"&&(p[Symbol.iterator]=function(){return this}),p;function y(h){return function(x){return b([h,x])}}function b(h){if(I)throw new TypeError("Generator is already executing.");for(;f;)try{if(I=1,k&&(g=h[0]&2?k.return:h[0]?k.throw||((g=k.return)&&g.call(k),0):k.next)&&!(g=g.call(k,h[1])).done)return g;switch(k=0,g&&(h=[h[0]&2,g.value]),h[0]){case 0:case 1:g=h;break;case 4:return f.label++,{value:h[1],done:!1};case 5:f.label++,k=h[1],h=[0];continue;case 7:h=f.ops.pop(),f.trys.pop();continue;default:if(g=f.trys,!(g=g.length>0&&g[g.length-1])&&(h[0]===6||h[0]===2)){f=0;continue}if(h[0]===3&&(!g||h[1]>g[0]&&h[1]<g[3])){f.label=h[1];break}if(h[0]===6&&f.label<g[1]){f.label=g[1],g=h;break}if(g&&f.label<g[2]){f.label=g[2],f.ops.push(h);break}g[2]&&f.ops.pop(),f.trys.pop();continue}h=m.call(c,f)}catch(x){h=[6,x],k=0}finally{I=g=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}};Object.defineProperty(r,"__esModule",{value:!0}),r.Header=r.Track=r.Midi=void 0;var s=$e(),n=Ie(),e=_e(),t=kt(),u=(function(){function c(m){var f=this,I=null;if(m){var k=m instanceof ArrayBuffer?new Uint8Array(m):m;I=(0,s.parseMidi)(k),I.tracks.forEach(function(g){var p=0;g.forEach(function(y){p+=y.deltaTime,y.absoluteTime=p})}),I.tracks=i(I.tracks)}this.header=new n.Header(I),this.tracks=[],m&&(this.tracks=I.tracks.map(function(g){return new e.Track(g,f.header)}),I.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return c.fromUrl=function(m){return l(this,void 0,void 0,function(){var f,I;return d(this,function(k){switch(k.label){case 0:return[4,fetch(m)];case 1:return f=k.sent(),f.ok?[4,f.arrayBuffer()]:[3,3];case 2:return I=k.sent(),[2,new c(I)];case 3:throw new Error("Could not load '".concat(m,"'"))}})})},Object.defineProperty(c.prototype,"name",{get:function(){return this.header.name},set:function(m){this.header.name=m},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"duration",{get:function(){var m=this.tracks.map(function(f){return f.duration});return Math.max.apply(Math,m)},enumerable:!1,configurable:!0}),Object.defineProperty(c.prototype,"durationTicks",{get:function(){var m=this.tracks.map(function(f){return f.durationTicks});return Math.max.apply(Math,m)},enumerable:!1,configurable:!0}),c.prototype.addTrack=function(){var m=new e.Track(void 0,this.header);return this.tracks.push(m),m},c.prototype.toArray=function(){return(0,t.encode)(this)},c.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(m){return m.toJSON()})}},c.prototype.fromJSON=function(m){var f=this;this.header=new n.Header,this.header.fromJSON(m.header),this.tracks=m.tracks.map(function(I){var k=new e.Track(void 0,f.header);return k.fromJSON(I),k})},c.prototype.clone=function(){var m=new c;return m.fromJSON(this.toJSON()),m},c})();r.Midi=u;var o=_e();Object.defineProperty(r,"Track",{enumerable:!0,get:function(){return o.Track}});var a=Ie();Object.defineProperty(r,"Header",{enumerable:!0,get:function(){return a.Header}});function i(c){for(var m=[],f=0;f<c.length;f++)for(var I=m.length,k=new Map,g=Array(16).fill(0),p=0,y=c[f];p<y.length;p++){var b=y[p],h=I,x=b.channel;if(x!==void 0){b.type==="programChange"&&(g[x]=b.programNumber);var C=g[x],Q="".concat(C," ").concat(x);k.has(Q)?h=k.get(Q):(h=I+k.size,k.set(Q,h))}m[h]||m.push([]),m[h].push(b)}return m}})(J)),J}var Je=xt();const ue="midiRecordings",We="autoRecordSetting",ze="outputChannelSetting",Tt=6e3;let ee=null,_=[],D=[],E=null,F=null,V="default",U=!1,M=!1,ke=0,v=[],B=null,me=null,De=[],$=0,w=0,q=null,S={},O=null,A=!0,te=null;const wt=500;let K=[],se=null;const St=document.getElementById("status-bar"),qe=document.getElementById("midi-indicator"),pe=document.getElementById("toggle-devices-button");document.getElementById("device-settings-title");const he=document.getElementById("device-status-led"),Ke=document.getElementById("device-selectors-container"),G=document.getElementById("midi-input"),Y=document.getElementById("midi-output"),ce=document.getElementById("output-channel"),X=document.getElementById("record-button"),Z=document.getElementById("play-button"),Ge=document.getElementById("save-button"),Ye=document.getElementById("export-button"),Ut=document.getElementById("import-midi-input"),R=document.getElementById("saved-recordings"),Qe=document.getElementById("load-button"),Xe=document.getElementById("rename-button"),Ze=document.getElementById("delete-button"),Ct=document.getElementById("playback-card"),j=document.getElementById("time-display"),H=document.getElementById("playback-slider"),xe=document.getElementById("auto-record-checkbox");function T(r){St.textContent=r}function et(){qe.classList.add("active"),setTimeout(()=>{qe.classList.remove("active")},150)}function tt(){E&&_.some(l=>l.id===E)?(he.classList.add("connected"),he.classList.remove("disconnected")):(he.classList.add("disconnected"),he.classList.remove("connected"))}function Ot(){const r=E,l=F;G.innerHTML="",_.length===0?G.innerHTML='<option value="">No input devices found</option>':(G.innerHTML='<option value="">Select an input...</option>',_.forEach(d=>{const s=document.createElement("option");s.value=d.id,s.textContent=d.name??"Unknown Input",G.appendChild(s)})),G.value=r??"",Y.innerHTML="",D.length===0?Y.innerHTML='<option value="">No output devices found</option>':(Y.innerHTML='<option value="">Select an output...</option>',D.forEach(d=>{const s=document.createElement("option");s.value=d.id,s.textContent=d.name??"Unknown Output",Y.appendChild(s)})),Y.value=l??"",tt(),N()}function le(){R.innerHTML="";const r=Object.keys(S);r.length===0&&(R.innerHTML="<option>No saved recordings</option>"),r.forEach(l=>{const d=document.createElement("option");d.value=l,d.textContent=l,R.appendChild(d)}),O&&S[O]?R.value=O:r.length>0?(O=r[0],R.value=O):O=null,N()}function N(){const r=v.some(d=>d.data.length===3&&(d.data[0]&240)===144&&d.data[2]>0),l=E&&_.some(d=>d.id===E);X.disabled=M||!l||A,Z.disabled=U||!r,Ge.disabled=U||M||!r||A,Ye.disabled=U||M||!r,Qe.disabled=U||M||!O,Xe.disabled=U||M||!O,Ze.disabled=U||M||!O,U?(X.classList.add("recording"),X.textContent="Stop"):(X.classList.remove("recording"),X.textContent="Record"),M?(Z.classList.add("playing"),Z.textContent="Stop"):(Z.classList.remove("playing"),Z.textContent="Play"),Ct.style.display=r?"block":"none"}function P(r){const l=Math.floor(r/60),d=Math.floor(r%60);return`${String(l).padStart(2,"0")}:${String(d).padStart(2,"0")}`}function rt(){if(!M){q&&clearInterval(q),q=null;return}const r=(performance.now()-ke+$)/1e3,l=Math.min(r,w);H.value=String(w>0?l/w*100:0),j.textContent=`${P(l)} / ${P(w)}`,l>=w&&w>0&&de()}function nt(){if(M||v.length===0)return;const r=D.find(s=>s.id===F);if(!r){T("Error: No output device selected for playback.");return}M=!0,ke=performance.now(),T(`Playing back recording: ${B??"Current Recording"}`),N(),ct(),q&&clearInterval(q),q=setInterval(rt,100);const l=v[0].timestamp;w=(v[v.length-1].timestamp-l)/1e3;const d=s=>{if(M)for(let n=s;n<v.length;n++){const e=v[n],t=e.timestamp-l;if(t<$)continue;if(t-(performance.now()-ke+$)>20){me=setTimeout(()=>d(n),20);return}const[o,a,i]=e.data;if(o>=240)continue;let c;V!=="default"?c=[o&240|parseInt(V,10)-1,a,i]:c=[o,a,i],r.send(c),(o&240)===144&&i>0&&et()}};d(0)}function de(r=!1){if(!M)return;M=!1,me&&(clearTimeout(me),me=null),De.forEach(clearTimeout),De=[],q&&(clearInterval(q),q=null);const l=D.find(d=>d.id===F);if(l)for(let d=0;d<16;d++)l.send([176+d,123,0]);r||($=0,rt(),H.value="0",j.textContent=`${P(0)} / ${P(w)}`),T("Playback stopped."),N(),ut()}function Mt(r){if(v.length===0)return;const l=M;l&&de(!0);const d=v[0].timestamp;w=(v[v.length-1].timestamp-d)/1e3,$=w*r/100*1e3;const s=$/1e3;j.textContent=`${P(s)} / ${P(w)}`,l&&nt()}function Et(){U?at():it()}function it(){U||!E||(v=[],B=null,U=!0,performance.now(),T("Recording..."),N(),ct(),w=0,$=0,H.value="0",j.textContent="00:00 / 00:00")}function at(){if(U){if(U=!1,v.length>0){const r=v[0].timestamp;v.forEach(l=>l.timestamp-=r),w=v[v.length-1].timestamp/1e3}else w=0;T(`Recording finished. Length: ${w.toFixed(1)}s.`),N(),ut(),j.textContent=`${P(0)} / ${P(w)}`}}function Bt(){if(v.length===0){T("Nothing to save.");return}const r=prompt("Enter a name for this recording:",B??`Recording ${new Date().toLocaleString()}`);r&&(S[r]=[...v],B=r,O=r,localStorage.setItem(ue,JSON.stringify(S)),T(`Recording saved as "${r}".`),le())}function Nt(){if(v.length===0)return;const r=`Auto-recording ${new Date().toLocaleString()}`;S[r]=[...v],B=r,O=r,localStorage.setItem(ue,JSON.stringify(S)),T(`Recording auto-saved as "${r}".`),le()}function Pt(){if(U)return;const r=R.value;r&&S[r]&&(de(),v=[...S[r]],B=r,O=r,T(`Loaded recording: "${r}".`),v.length>0?w=v[v.length-1].timestamp/1e3:w=0,$=0,H.value="0",j.textContent=`${P(0)} / ${P(w)}`,N())}function Ft(){const r=O;if(!r||!S[r]){T("No recording selected to rename.");return}const l=prompt(`Enter a new name for "${r}":`,r);if(l&&l!==r){if(S[l]){T(`Error: A recording named "${l}" already exists.`);return}S[l]=S[r],delete S[r],O=l,B===r&&(B=l),localStorage.setItem(ue,JSON.stringify(S)),T(`Renamed "${r}" to "${l}".`),le()}}function _t(){const r=R.value;r&&S[r]&&confirm(`Are you sure you want to delete "${r}"?`)&&(delete S[r],localStorage.setItem(ue,JSON.stringify(S)),T(`Deleted recording: "${r}".`),B===r&&(v=[],B=null,w=0,j.textContent="00:00 / 00:00",H.value="0"),O=null,le())}function Lt(){if(v.length===0){T("No recording to export.");return}try{const r=new Je.Midi,l=r.addTrack();if(v.length>0){let u=0;v.forEach(o=>{const[a,i,c]=o.data,m=a&240,f=(o.timestamp-u)/1e3;switch(m){case 144:l.addNote({midi:i,time:f,velocity:c/127,duration:0});break;case 128:l.addNote({midi:i,time:f,velocity:0,duration:0});break;case 176:l.addCC({number:i,value:c/127,time:f});break}u=o.timestamp})}const d=r.toArray(),s=new Blob([d],{type:"audio/midi"}),n=URL.createObjectURL(s),e=document.createElement("a");e.href=n;const t=B?`${B}.mid`:`midi-recording-${Date.now()}.mid`;e.download=t,document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(n),T(`Exported as ${t}`)}catch(r){console.error("Failed to export MIDI:",r),T("Error: Failed to export MIDI file.")}}async function Rt(r){try{const l=await r.arrayBuffer(),d=new Je.Midi(l);if(d.tracks.length===0){T("Error: MIDI file has no tracks.");return}de(),v=[];let s=[];d.tracks.forEach(n=>{n.notes.forEach(e=>{s.push({...e,startTime:e.time,endTime:e.time+e.duration})})}),s.sort((n,e)=>n.startTime-e.startTime),s.forEach(n=>{v.push({data:[144|n.channel,n.midi,Math.round(n.velocity*127)],timestamp:n.startTime*1e3}),v.push({data:[128|n.channel,n.midi,0],timestamp:n.endTime*1e3})}),v.sort((n,e)=>n.timestamp-e.timestamp),v.length>0?w=v[v.length-1].timestamp/1e3:w=0,B=r.name.replace(/\.(mid|midi)$/i,""),T(`Imported: ${r.name}`),N(),$=0,H.value="0",j.textContent=`${P(0)} / ${P(w)}`}catch(l){console.error("Failed to import MIDI:",l),T("Error: Could not parse MIDI file.")}}function Dt(r){ee=r,ee.onstatechange=qt,T("MIDI ready. Select input/output devices."),ot()}function Ae(r){T(`Failed to get MIDI access - ${r}`),console.error(`Failed to get MIDI access - ${r}`)}function qt(){ot()}function ot(){ee&&(_=Array.from(ee.inputs.values()),D=Array.from(ee.outputs.values()),E&&!_.some(r=>r.id===E)&&(E=null),F&&!D.some(r=>r.id===F)&&(F=null),!E&&_.length>0&&(E=_[0].id),!F&&D.length>0&&(F=D[0].id),Ot(),st())}function st(){if(!ee)return;_.forEach(l=>{l.onmidimessage=null});const r=_.find(l=>l.id===E);r?(T(`Listening to ${r.name}...`),r.onmidimessage=At):T("No input device selected.")}function At(r){const l=Array.from(r.data),[d,s,n]=l,e=D.find(o=>o.id===F);if(e){let o;V!=="default"?o=[d&240|parseInt(V,10)-1,s,n]:o=l,e.send(o)}const t=(d&240)===144&&n>0,u=(d&240)===128||(d&240)===144&&n===0;if(t&&et(),A&&t&&!U&&it(),A&&U&&(t||u)&&(te&&clearTimeout(te),te=setTimeout(()=>{U&&(T("Silence detected, stopping auto-record."),at(),Nt())},Tt)),d<240){const o=performance.now();for(K.push({data:l,timestamp:o});K.length>0&&o-K[0].timestamp>wt;)K.shift();U&&(v.length===0&&(v.push(...K),K.length>0?K[0].timestamp:performance.now()),v.push({data:l,timestamp:o}))}}async function ct(){if("wakeLock"in navigator)try{se=await navigator.wakeLock.request("screen"),se.addEventListener("release",()=>{})}catch(r){console.error(`${r.name}, ${r.message}`),T("Warning: Could not acquire screen wake lock.")}}async function ut(){se&&(await se.release(),se=null)}function $t(){pe.addEventListener("click",()=>{const r=pe.getAttribute("aria-expanded")==="true";pe.setAttribute("aria-expanded",String(!r)),Ke.classList.toggle("expanded")}),G.addEventListener("change",()=>{E=G.value||null,st(),tt(),N()}),Y.addEventListener("change",()=>{F=Y.value||null}),ce.addEventListener("change",()=>{V=ce.value,localStorage.setItem(ze,V)}),X.addEventListener("click",Et),Z.addEventListener("click",()=>{M?de():nt()}),Ge.addEventListener("click",Bt),Ye.addEventListener("click",Lt),Ut.addEventListener("change",r=>{var d;const l=(d=r.target.files)==null?void 0:d[0];l&&(Rt(l),r.target.value="")}),R.addEventListener("change",()=>{O=R.value,N()}),Qe.addEventListener("click",Pt),Xe.addEventListener("click",Ft),Ze.addEventListener("click",_t),H.addEventListener("input",()=>{Mt(parseInt(H.value,10))}),xe.addEventListener("change",()=>{A=xe.checked,localStorage.setItem(We,JSON.stringify(A)),!A&&te&&(clearTimeout(te),te=null),N()})}function jt(){ce.innerHTML='<option value="default">Default (Passthrough)</option>';for(let s=1;s<=16;s++){const n=document.createElement("option");n.value=String(s-1),n.textContent=`Channel ${s}`,ce.appendChild(n)}const r=localStorage.getItem(ue);if(r)try{S=JSON.parse(r)}catch(s){console.error("Could not parse saved recordings:",s)}le(),Ke.classList.remove("expanded"),pe.setAttribute("aria-expanded","false");const l=localStorage.getItem(We);l!==null&&(A=JSON.parse(l),xe.checked=A);const d=localStorage.getItem(ze);d!==null&&(V=d,ce.value=V),navigator.requestMIDIAccess?navigator.requestMIDIAccess({sysex:!1}).then(Dt,()=>Ae("Permission denied or system error.")):Ae("Web MIDI API not supported in this browser."),$t(),N(),j.textContent="00:00 / 00:00"}jt();
